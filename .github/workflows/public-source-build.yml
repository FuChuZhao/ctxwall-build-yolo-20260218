name: Public Source Build

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Private source repo (owner/name)"
        required: true
        type: string
      source_ref:
        description: "Branch/tag/SHA to build from source repo"
        required: true
        type: string
      artifact_name:
        description: "Uploaded artifact name"
        required: true
        default: "build-output"
        type: string
      build_entry:
        description: "Build entry script path in source repo"
        required: true
        default: "tool/ci/build_entry.sh"
        type: string
      artifact_path:
        description: "Output path generated by build entry (absolute or source-relative)"
        required: true
        default: "ci-artifact"
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Setup SSH for private source repo
        shell: bash
        run: |
          set -euo pipefail
          install -m 700 -d "$HOME/.ssh"
          cat > "$HOME/.ssh/id_ed25519" <<'EOF'
          ${{ secrets.SOURCE_REPO_SSH_KEY }}
          EOF
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan github.com >> "$HOME/.ssh/known_hosts"

      - name: Clone private source repo at source_ref
        shell: bash
        run: |
          set -euo pipefail
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git fetch --depth 1 origin "${{ inputs.source_ref }}"
          git checkout --detach FETCH_HEAD
          git rev-parse --short HEAD

      - name: Install native build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            pkg-config \
            libx11-dev \
            libxft-dev \
            libfreetype6-dev \
            xvfb \
            xdotool \
            imagemagick \
            ffmpeg

      - name: Build from private source entry script
        shell: bash
        run: |
          set -euo pipefail
          cd source
          chmod +x "${{ inputs.build_entry }}"
          "${{ inputs.build_entry }}" "${{ github.workspace }}/${{ inputs.artifact_path }}"

      - name: Normalize artifact directory
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ github.workspace }}/artifact-final"
          cp -a "${{ github.workspace }}/${{ inputs.artifact_path }}/." "${{ github.workspace }}/artifact-final/"

      - name: Upload artifact (minimal retention)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ github.workspace }}/artifact-final
          retention-days: 1
          if-no-files-found: error
